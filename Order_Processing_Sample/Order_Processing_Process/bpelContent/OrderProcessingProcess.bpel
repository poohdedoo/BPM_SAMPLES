<!-- OrderprocessingProcess BPEL Process [Generated by the Eclipse BPEL Designer] -->
<bpel:process name="OrderprocessingProcess"
	targetNamespace="http://wso2.org/bps/sample/Orderprocessing"
	suppressJoinFailure="yes" xmlns:tns="http://wso2.org/bps/sample/Orderprocessing"
	xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
	xmlns:b4p="http://docs.oasis-open.org/ns/bpel4people/bpel4people/200803"
	xmlns:process="http://wso2.org/bps/sample/OrderprocessingArtifacts"
	xmlns:ns="http://www.wso2.org/samples/OrderProcessingProcess/"
	xmlns:htt="http://docs.oasis-open.org/ns/bpel4people/ws-humantask/types/200803"
	xmlns:ns0="http://www.wso2.org/samples/InvoicingService/" xmlns:task="http://www.wso2.org/samples/OrderProcessingApprovalTask/"
	xmlns:ns1="http://org.wso2.brs.sample/ns" xmlns:rule="http://org.wso2.brs.sample/warehouselocator"
	xmlns:ns2="http://www.wso2.org/samples/PlaceOrderService/">

	<!-- ================================================================= -->
	<!-- ORCHESTRATION LOGIC -->
	<!-- Set of activities coordinating the flow of messages across the -->
	<!-- services integrated within this business process -->
	<!-- ================================================================= -->
	<bpel:extensions>
		<bpel:extension
			namespace="http://docs.oasis-open.org/ns/bpel4people/bpel4people/200803"
			mustUnderstand="yes"></bpel:extension>
	</bpel:extensions>
	<bpel:import namespace="http://www.wso2.org/samples/OrderProcessingApprovalTask/"
		location="OrderProcessingApprovalTask.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"></bpel:import>
	<bpel:import namespace="http://www.wso2.org/samples/InvoicingService/"
		location="InvoicingService.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"></bpel:import>
	<bpel:import namespace="http://www.wso2.org/samples/OrderProcessingProcess/"
		location="OrderProcessingProcess.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"></bpel:import>
	<bpel:import namespace="http://wso2.org/bps/sample/OrderprocessingArtifacts"
		location="OrderProcessingProcessArtifacts.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"></bpel:import>
	<bpel:partnerLinks>
		<bpel:partnerLink name="OrderProcessingProcess"
			partnerLinkType="process:OrderProcessingProcessPLT" myRole="OrderProcessingProcessProvider"></bpel:partnerLink>
		<bpel:partnerLink name="InvoicingService"
			partnerLinkType="process:InvoicingServicePLT" partnerRole="InvoicingServiceProvider"></bpel:partnerLink>
		<bpel:partnerLink name="NotificationService"
			partnerLinkType="process:HumanNotificationServicePLT" partnerRole="HumanNotificationServiceProvider"></bpel:partnerLink>
		<bpel:partnerLink name="OrderApprovalTask"
			partnerLinkType="process:OrderApprovalTask" partnerRole="OrderApprovalProvider"
			myRole="OrderApprovalResultProvider"></bpel:partnerLink>
		<bpel:partnerLink name="WarehouseLocatorRuleService"
			partnerLinkType="process:WarehouseLocatorServicePLT" partnerRole="WarehouseLocatorProvider"></bpel:partnerLink>
		<bpel:partnerLink name="PlaceOrderService"
			partnerLinkType="process:PlaceOrderServicePLT" partnerRole="PlaceOrderProvider"></bpel:partnerLink>
	</bpel:partnerLinks>
	<bpel:variables>
		<bpel:variable name="OrderProcessingProcessRequest"
			messageType="ns:processRequest"></bpel:variable>
		<bpel:variable name="InvoicingServiceResponse"
			messageType="ns0:InvoiceResponse"></bpel:variable>
		<bpel:variable name="InvoicingServiceRequest"
			messageType="ns0:InvoiceRequest"></bpel:variable>
		<bpel:variable name="OrderProcessingProcessResponse"
			messageType="ns:processResponse"></bpel:variable>

		<bpel:variable name="NotificationServiceRequest"
			messageType="task:notifyRequest"></bpel:variable>
		<bpel:variable name="OrderApprovalTaskRequest"
			messageType="task:approveRequest"></bpel:variable>
		<bpel:variable name="OrderApprovalTaskOutcome"
			messageType="task:completeTaskRequest"></bpel:variable>
		<bpel:variable name="WarehouseLocatorRuleServiceResponse"
			messageType="ns1:getWarehouseDetailsResponseMessage"></bpel:variable>
		<bpel:variable name="WarehouseLocatorRuleServiceRequest"
			messageType="ns1:getWarehouseDetailsRequestMessage"></bpel:variable>
		<bpel:variable name="PlaceOrderServiceResponse"
			messageType="ns2:placeOrderResponse"></bpel:variable>
		<bpel:variable name="PlaceOrderServiceRequest"
			messageType="ns2:placeOrderRequest"></bpel:variable>
	</bpel:variables>
	<bpel:sequence name="main">

		<bpel:receive name="ReceiveOrderProcessingRequest"
			partnerLink="OrderProcessingProcess" operation="process"
			portType="ns:OrderProcessingProcess" variable="OrderProcessingProcessRequest"
			createInstance="yes"></bpel:receive>
		<bpel:sequence name="OrderProcessingSequence">
			<bpel:sequence name="InvoicingSequence">
				<bpel:assign validate="no" name="AssignInvoicingRequest">
					<bpel:copy>
						<bpel:from>
							<bpel:literal>
								<tns:Invoice xmlns:tns="http://www.wso2.org/samples/InvoicingService/"
									xmlns:tns1="http://www.wso2.org/samples/OrderProcessingProcess/"
									xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
									<tns1:customerID>tns1:customerID</tns1:customerID>
									<tns1:items>
										<tns1:item>
											<tns1:itemID>tns1:itemID</tns1:itemID>
											<tns1:quantity>0</tns1:quantity>
										</tns1:item>
									</tns1:items>
									<tns1:shippingAddress>tns1:shippingAddress
									</tns1:shippingAddress>
									<tns1:city>tns1:city</tns1:city>
								</tns:Invoice>
							</bpel:literal>
						</bpel:from>
						<bpel:to variable="InvoicingServiceRequest" part="Invoice"></bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from part="process" variable="OrderProcessingProcessRequest">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:customerID]]></bpel:query>
						</bpel:from>
						<bpel:to part="Invoice" variable="InvoicingServiceRequest">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:customerID]]></bpel:query>
						</bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from part="process" variable="OrderProcessingProcessRequest">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[ns:items]]>
							</bpel:query>
						</bpel:from>
						<bpel:to part="Invoice" variable="InvoicingServiceRequest">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:items]]></bpel:query>
						</bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from part="process" variable="OrderProcessingProcessRequest">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[ns:shippingAddress]]>
							</bpel:query>
						</bpel:from>
						<bpel:to part="Invoice" variable="InvoicingServiceRequest">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:shippingAddress]]></bpel:query>
						</bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from part="process" variable="OrderProcessingProcessRequest">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[ns:city]]>
							</bpel:query>
						</bpel:from>
						<bpel:to part="Invoice" variable="InvoicingServiceRequest">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:city]]></bpel:query>
						</bpel:to>
					</bpel:copy>
				</bpel:assign>
				<bpel:invoke name="InvokeInvoicingService" partnerLink="InvoicingService"
					operation="Invoice" portType="ns0:InvoicingService" inputVariable="InvoicingServiceRequest"
					outputVariable="InvoicingServiceResponse"></bpel:invoke>
			</bpel:sequence>
			<bpel:if name="IfReviewRequired">
				<bpel:condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[$InvoicingServiceResponse.InvoiceResponse/totalAmount>500]]></bpel:condition>
				<bpel:sequence name="ReviewOrder">
					<bpel:assign validate="no" name="AssignOrderProcessingResponse">
						<bpel:copy>
							<bpel:from>
								<bpel:literal>
									<tns:processResponse
										xmlns:tns="http://www.wso2.org/samples/OrderProcessingProcess/"
										xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
										<tns:orderID>tns:orderID</tns:orderID>
										<tns:status>tns:status</tns:status>
										<tns:total>0.0</tns:total>
										<tns:details>tns:details</tns:details>
									</tns:processResponse>
								</bpel:literal>
							</bpel:from>
							<bpel:to variable="OrderProcessingProcessResponse" part="processResponse"></bpel:to>
						</bpel:copy>
						<bpel:copy>
							<bpel:from part="InvoiceResponse" variable="InvoicingServiceResponse">
								<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[orderID]]></bpel:query>
							</bpel:from>
							<bpel:to part="processResponse" variable="OrderProcessingProcessResponse">
								<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:orderID]]></bpel:query>
							</bpel:to>
						</bpel:copy>
						<bpel:copy>
							<bpel:from part="InvoiceResponse" variable="InvoicingServiceResponse">
								<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[totalAmount]]>
								</bpel:query>
							</bpel:from>
							<bpel:to part="processResponse" variable="OrderProcessingProcessResponse">
								<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:total]]></bpel:query>
							</bpel:to>
						</bpel:copy>
						<bpel:copy>
							<bpel:from>
								<bpel:literal>Reviewing Order.</bpel:literal>
							</bpel:from>
							<bpel:to part="processResponse" variable="OrderProcessingProcessResponse">
								<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:status]]></bpel:query>
							</bpel:to>
						</bpel:copy>
						<bpel:copy>
							<bpel:from>
								<bpel:literal>Your total order value is exceeding transaction limit. We are reviewing your order.
								</bpel:literal>
							</bpel:from>
							<bpel:to part="processResponse" variable="OrderProcessingProcessResponse">
								<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:details]]></bpel:query>
							</bpel:to>
						</bpel:copy>
					</bpel:assign>


					<bpel:reply name="ReplyOrderProcessingCallee"
						partnerLink="OrderProcessingProcess" operation="process"
						portType="ns:OrderProcessingProcess" variable="OrderProcessingProcessResponse"></bpel:reply>
					<bpel:assign validate="no" name="AssignReviewNotificationRequest">
						<bpel:copy>
							<bpel:from>
								<bpel:literal>
									<tns:notify
										xmlns:tns="http://www.wso2.org/samples/OrderProcessingApprovalTask/"
										xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
										<tns:orderID>tns:orderID</tns:orderID>
										<tns:customer>
											<htt:user
												xmlns:htt="http://docs.oasis-open.org/ns/bpel4people/ws-humantask/types/200803">admin</htt:user>
										</tns:customer>
										<tns:subject>tns:subject</tns:subject>
										<tns:message>tns:message</tns:message>
									</tns:notify>
								</bpel:literal>
							</bpel:from>
							<bpel:to part="notify" variable="NotificationServiceRequest">
							</bpel:to>
						</bpel:copy>
						<bpel:copy>
							<bpel:from part="InvoiceResponse" variable="InvoicingServiceResponse">
								<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[orderID]]>
								</bpel:query>
							</bpel:from>
							<bpel:to part="notify" variable="NotificationServiceRequest">
								<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[task:orderID]]>
								</bpel:query>
							</bpel:to>
						</bpel:copy>
						<bpel:copy>
							<bpel:from part="Invoice" variable="InvoicingServiceRequest">
								<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:customerID]]></bpel:query>
							</bpel:from>
							<bpel:to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[$NotificationServiceRequest.notify/task:customer/htt:user]]>
							</bpel:to>
						</bpel:copy>
						<bpel:copy>
							<bpel:from>
								<bpel:literal>Reviewing Order.</bpel:literal>
							</bpel:from>
							<bpel:to part="notify" variable="NotificationServiceRequest">
								<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[task:subject]]>
								</bpel:query>
							</bpel:to>
						</bpel:copy>
						<bpel:copy>
							<bpel:from>
								<bpel:literal>Your total order value is exceeding transaction limit. We are reviewing your order.
								</bpel:literal>
							</bpel:from>
							<bpel:to part="notify" variable="NotificationServiceRequest">
								<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[task:message]]></bpel:query>
							</bpel:to>
						</bpel:copy>
					</bpel:assign>
					<bpel:invoke name="InvokeNotificatoinReveiw"
						partnerLink="NotificationService" operation="notify"
						portType="task:OrderProcessingNotifications" inputVariable="NotificationServiceRequest"></bpel:invoke>
					<bpel:assign validate="no" name="AssignOrderApprovalTaskRequest">
						<bpel:copy>
							<bpel:from>
								<bpel:literal>
									<tns:completeTask
										xmlns:tns="http://www.wso2.org/samples/OrderProcessingApprovalTask/"
										xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
										<tns:decision>false</tns:decision>
										<tns:reviewerComments>Automated Rejection.
										</tns:reviewerComments>
									</tns:completeTask>
								</bpel:literal>
							</bpel:from>
							<bpel:to variable="OrderApprovalTaskOutcome" part="completeTask"></bpel:to>
						</bpel:copy>
						<bpel:copy>
							<bpel:from>
								<bpel:literal>
									<tns:approve
										xmlns:tns="http://www.wso2.org/samples/OrderProcessingApprovalTask/"
										xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
										<tns:orderID>tns:orderID</tns:orderID>
										<tns:customerID>tns:customerID</tns:customerID>
										<tns:totalAmount>0.0</tns:totalAmount>
										<tns:city>tns:city</tns:city>
									</tns:approve>
								</bpel:literal>
							</bpel:from>
							<bpel:to variable="OrderApprovalTaskRequest" part="approve"></bpel:to>
						</bpel:copy>
						<bpel:copy>
							<bpel:from part="InvoiceResponse" variable="InvoicingServiceResponse">
								<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[orderID]]>
								</bpel:query>
							</bpel:from>
							<bpel:to part="approve" variable="OrderApprovalTaskRequest">
								<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[task:orderID]]>
								</bpel:query>
							</bpel:to>
						</bpel:copy>
						<bpel:copy>
							<bpel:from part="InvoiceResponse" variable="InvoicingServiceResponse">
								<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[totalAmount]]>
								</bpel:query>
							</bpel:from>
							<bpel:to part="approve" variable="OrderApprovalTaskRequest">
								<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[task:totalAmount]]></bpel:query>
							</bpel:to>
						</bpel:copy>
						<bpel:copy>
							<bpel:from part="process" variable="OrderProcessingProcessRequest">
								<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[ns:customerID]]>
								</bpel:query>
							</bpel:from>
							<bpel:to part="approve" variable="OrderApprovalTaskRequest">
								<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[task:customerID]]>
								</bpel:query>
							</bpel:to>
						</bpel:copy>
						<bpel:copy>
							<bpel:from part="process" variable="OrderProcessingProcessRequest">
								<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[ns:city]]>
								</bpel:query>
							</bpel:from>
							<bpel:to part="approve" variable="OrderApprovalTaskRequest">
								<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[task:city]]></bpel:query>
							</bpel:to>
						</bpel:copy>

					</bpel:assign>
					<bpel:extensionActivity>
						<b4p:peopleActivity name="ReviewInvoice"
							inputVariable="OrderApprovalTaskRequest" outputVariable="OrderApprovalTaskOutcome"
							isSkipable="yes">
							<b4p:remoteTask partnerLink="OrderApprovalTask"
								operation="approve" responseOperation="completeTask"></b4p:remoteTask>
						</b4p:peopleActivity>
					</bpel:extensionActivity>
					<bpel:if name="IfApproved">
						<bpel:condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[$OrderApprovalTaskOutcome.completeTask/task:decision/text() = 'true']]></bpel:condition>
						<bpel:sequence name="Approved">

							<bpel:assign validate="no"
								name="AssignApprovalNotificationRequest">
								<bpel:copy>
									<bpel:from>
										<bpel:literal>
											<tns:notify
												xmlns:tns="http://www.wso2.org/samples/OrderProcessingApprovalTask/"
												xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
												<tns:orderID>tns:orderID</tns:orderID>
												<tns:customer>
													<htt:user
														xmlns:htt="http://docs.oasis-open.org/ns/bpel4people/ws-humantask/types/200803">admin</htt:user>
												</tns:customer>
												<tns:subject>tns:subject</tns:subject>
												<tns:message>tns:message</tns:message>
											</tns:notify>
										</bpel:literal>
									</bpel:from>
									<bpel:to part="notify" variable="NotificationServiceRequest">
									</bpel:to>
								</bpel:copy>
								<bpel:copy>
									<bpel:from part="InvoiceResponse" variable="InvoicingServiceResponse">
										<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[orderID]]>
										</bpel:query>
									</bpel:from>
									<bpel:to part="notify" variable="NotificationServiceRequest">
										<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[task:orderID]]>
										</bpel:query>
									</bpel:to>
								</bpel:copy>
								<bpel:copy>
									<bpel:from part="Invoice" variable="InvoicingServiceRequest">
										<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:customerID]]></bpel:query>
									</bpel:from>
									<bpel:to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[$NotificationServiceRequest.notify/task:customer/htt:user]]>
									</bpel:to>
								</bpel:copy>
								<bpel:copy>
									<bpel:from>
										<bpel:literal>Order Reviewed.</bpel:literal>
									</bpel:from>
									<bpel:to part="notify" variable="NotificationServiceRequest">
										<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[task:subject]]>
										</bpel:query>
									</bpel:to>
								</bpel:copy>
								<bpel:copy>
									<bpel:from>
										<bpel:literal>Your order has been approved. We are placing order.
										</bpel:literal>
									</bpel:from>
									<bpel:to part="notify" variable="NotificationServiceRequest">
										<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[task:message]]></bpel:query>
									</bpel:to>
								</bpel:copy>
							</bpel:assign>
							<bpel:invoke name="InvokeNotificatoinApproval"
								partnerLink="NotificationService" operation="notify"
								portType="task:OrderProcessingNotifications" inputVariable="NotificationServiceRequest"></bpel:invoke>
						</bpel:sequence>
						<bpel:else>
							<bpel:sequence name="Rejected">
								<bpel:assign validate="no"
									name="AssignApprovalNotificationRequest">
									<bpel:copy>
										<bpel:from>
											<bpel:literal>
												<tns:notify
													xmlns:tns="http://www.wso2.org/samples/OrderProcessingApprovalTask/"
													xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
													<tns:orderID>tns:orderID</tns:orderID>
													<tns:customer>
														<htt:user
															xmlns:htt="http://docs.oasis-open.org/ns/bpel4people/ws-humantask/types/200803">admin</htt:user>
													</tns:customer>
													<tns:subject>tns:subject</tns:subject>
													<tns:message>tns:message</tns:message>
												</tns:notify>
											</bpel:literal>
										</bpel:from>
										<bpel:to part="notify" variable="NotificationServiceRequest">
										</bpel:to>
									</bpel:copy>
									<bpel:copy>
										<bpel:from part="InvoiceResponse" variable="InvoicingServiceResponse">
											<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[orderID]]>
											</bpel:query>
										</bpel:from>
										<bpel:to part="notify" variable="NotificationServiceRequest">
											<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[task:orderID]]>
											</bpel:query>
										</bpel:to>
									</bpel:copy>
									<bpel:copy>
										<bpel:from part="Invoice" variable="InvoicingServiceRequest">
											<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:customerID]]></bpel:query>
										</bpel:from>
										<bpel:to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[$NotificationServiceRequest.notify/task:customer/htt:user]]>
										</bpel:to>
									</bpel:copy>
									<bpel:copy>
										<bpel:from>
											<bpel:literal>Order Reviewed.</bpel:literal>
										</bpel:from>
										<bpel:to part="notify" variable="NotificationServiceRequest">
											<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[task:subject]]>
											</bpel:query>
										</bpel:to>
									</bpel:copy>
									<bpel:copy>
										<bpel:from>
											<bpel:literal>Your order has been rejected. Please contact our customer care for further information.
											</bpel:literal>
										</bpel:from>
										<bpel:to part="notify" variable="NotificationServiceRequest">
											<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[task:message]]></bpel:query>
										</bpel:to>
									</bpel:copy>
								</bpel:assign>
								<bpel:invoke name="InvokeNotificationRejection"
									partnerLink="NotificationService" operation="notify"
									portType="task:OrderProcessingNotifications" inputVariable="NotificationServiceRequest"></bpel:invoke>
								<bpel:exit name="Exit"></bpel:exit>
							</bpel:sequence>
						</bpel:else>
					</bpel:if>
				</bpel:sequence>
				<bpel:else>
					<bpel:sequence name="ReviewNotRequired">
						<bpel:assign validate="no" name="AssignOrderProcessingResponse">
							<bpel:copy>
								<bpel:from>
									<bpel:literal>
										<tns:processResponse
											xmlns:tns="http://www.wso2.org/samples/OrderProcessingProcess/"
											xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
											<tns:orderID>tns:orderID</tns:orderID>
											<tns:status>tns:status</tns:status>
											<tns:total>0.0</tns:total>
											<tns:details>tns:details</tns:details>
										</tns:processResponse>
									</bpel:literal>
								</bpel:from>
								<bpel:to variable="OrderProcessingProcessResponse" part="processResponse"></bpel:to>
							</bpel:copy>
							<bpel:copy>
								<bpel:from part="InvoiceResponse" variable="InvoicingServiceResponse">
									<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[orderID]]></bpel:query>
								</bpel:from>
								<bpel:to part="processResponse" variable="OrderProcessingProcessResponse">
									<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:orderID]]></bpel:query>
								</bpel:to>
							</bpel:copy>
							<bpel:copy>
								<bpel:from part="InvoiceResponse" variable="InvoicingServiceResponse">
									<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[totalAmount]]>
									</bpel:query>
								</bpel:from>
								<bpel:to part="processResponse" variable="OrderProcessingProcessResponse">
									<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:total]]></bpel:query>
								</bpel:to>
							</bpel:copy>
							<bpel:copy>
								<bpel:from>
									<bpel:literal>Submited for invoing service.</bpel:literal>
								</bpel:from>
								<bpel:to part="processResponse" variable="OrderProcessingProcessResponse">
									<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:status]]></bpel:query>
								</bpel:to>
							</bpel:copy>
							<bpel:copy>
								<bpel:from>
									<bpel:literal>We have successfully submitted your order.
									</bpel:literal>
								</bpel:from>
								<bpel:to part="processResponse" variable="OrderProcessingProcessResponse">
									<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:details]]></bpel:query>
								</bpel:to>
							</bpel:copy>
						</bpel:assign>
						<bpel:reply name="ReplyOrderProcessingCallee"
							partnerLink="OrderProcessingProcess" operation="process"
							portType="ns:OrderProcessingProcess" variable="OrderProcessingProcessResponse"></bpel:reply>
					</bpel:sequence>
				</bpel:else>
			</bpel:if>
			<bpel:sequence name="SequenceCalculateShippingLocation">
				<bpel:assign validate="no"
					name="AssignWarehouseLocatorRuleServiceRequest">
					<bpel:copy>
						<bpel:from>
							<bpel:literal>
								<ax2410:getWarehouseDetailsRequest
									xmlns:ax2410="http://org.wso2.brs.sample/warehouselocator"
									xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
									<ax2410:Request>
										<ax2410:cityName>ax2410:cityName</ax2410:cityName>
									</ax2410:Request>
								</ax2410:getWarehouseDetailsRequest>
							</bpel:literal>
						</bpel:from>
						<bpel:to variable="WarehouseLocatorRuleServiceRequest"
							part="parameters"></bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from part="process" variable="OrderProcessingProcessRequest">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[ns:city]]>
							</bpel:query>
						</bpel:from>
						<bpel:to part="parameters" variable="WarehouseLocatorRuleServiceRequest">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[rule:Request[1]/rule:cityName]]>
							</bpel:query>
						</bpel:to>
					</bpel:copy>
				</bpel:assign>
				<bpel:invoke name="InvokeWarehouseLocatorRuleService"
					partnerLink="WarehouseLocatorRuleService" operation="getWarehouseDetails"
					inputVariable="WarehouseLocatorRuleServiceRequest" outputVariable="WarehouseLocatorRuleServiceResponse"></bpel:invoke>
			</bpel:sequence>

			<bpel:sequence name="SequencePlaceOrder">
				<bpel:assign validate="no" name="AssignPlaceOrderRequest">
					<bpel:copy>
						<bpel:from>
							<bpel:literal>
								<tns:placeOrder xmlns:tns="http://www.wso2.org/samples/PlaceOrderService/"
									xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
									<OrderID>OrderID</OrderID>
									<WarehouseLocation>WarehouseLocation</WarehouseLocation>
									<CustomerAddress>CustomerAddress</CustomerAddress>
								</tns:placeOrder>
							</bpel:literal>
						</bpel:from>
						<bpel:to variable="PlaceOrderServiceRequest" part="parameters"></bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from part="InvoiceResponse" variable="InvoicingServiceResponse">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[orderID]]>
							</bpel:query>
						</bpel:from>
						<bpel:to part="parameters" variable="PlaceOrderServiceRequest">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[OrderID]]>
							</bpel:query>
						</bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from part="parameters" variable="WarehouseLocatorRuleServiceResponse">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[rule:Response[1]/rule:warehouse/rule:address]]>
							</bpel:query>
						</bpel:from>
						<bpel:to part="parameters" variable="PlaceOrderServiceRequest">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[WarehouseLocation]]>
							</bpel:query>
						</bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from part="process" variable="OrderProcessingProcessRequest">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[ns:shippingAddress]]>
							</bpel:query>
						</bpel:from>
						<bpel:to part="parameters" variable="PlaceOrderServiceRequest">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[CustomerAddress]]></bpel:query>
						</bpel:to>
					</bpel:copy>
				</bpel:assign>
				<bpel:invoke name="InvokePlaceOrderService" partnerLink="PlaceOrderService"
					operation="placeOrder" inputVariable="PlaceOrderServiceRequest"
					outputVariable="PlaceOrderServiceResponse"></bpel:invoke>
			</bpel:sequence>
			<bpel:sequence name="NotifyFinalStatus">
				<bpel:assign validate="no"
					name="AssignApprovalNotificationRequest">
					<bpel:copy>
						<bpel:from>
							<bpel:literal>
								<tns:notify
									xmlns:tns="http://www.wso2.org/samples/OrderProcessingApprovalTask/"
									xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
									<tns:orderID>tns:orderID</tns:orderID>
									<tns:customer>
										<htt:user
											xmlns:htt="http://docs.oasis-open.org/ns/bpel4people/ws-humantask/types/200803">admin</htt:user>
									</tns:customer>
									<tns:subject>tns:subject</tns:subject>
									<tns:message>tns:message</tns:message>
								</tns:notify>
							</bpel:literal>
						</bpel:from>
						<bpel:to part="notify" variable="NotificationServiceRequest">
						</bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from part="InvoiceResponse" variable="InvoicingServiceResponse">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[orderID]]>
							</bpel:query>
						</bpel:from>
						<bpel:to part="notify" variable="NotificationServiceRequest">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[task:orderID]]>
							</bpel:query>
						</bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from part="Invoice" variable="InvoicingServiceRequest">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns:customerID]]></bpel:query>
						</bpel:from>
						<bpel:to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[$NotificationServiceRequest.notify/task:customer/htt:user]]>
						</bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">                            
                            
                            <![CDATA[concat(" We have placed your order. Estimated dilivery date is ", $PlaceOrderServiceResponse.parameters/EstimatedShippingDate )]]>
                        </bpel:from>
						<bpel:to part="notify" variable="NotificationServiceRequest">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[task:message]]></bpel:query>
						</bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from>
							<bpel:literal>We have placed your order.</bpel:literal>
						</bpel:from>
						<bpel:to part="notify" variable="NotificationServiceRequest">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[task:subject]]></bpel:query>
						</bpel:to>
					</bpel:copy>
				</bpel:assign>
				<bpel:invoke name="InvokeNotificatoinApproval"
					partnerLink="NotificationService" operation="notify"
					portType="task:OrderProcessingNotifications" inputVariable="NotificationServiceRequest"></bpel:invoke>
			</bpel:sequence>
		</bpel:sequence>
	</bpel:sequence>
</bpel:process>

